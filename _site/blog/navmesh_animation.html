<!DOCTYPE html><html lang="en"><meta charset="utf-8"><title>Adding NavMesh, Agents and Animation in Cocos2d-x</title><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="this is meta description"><link rel="stylesheet" href="/assets/plugins/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/plugins/themify-icons/themify-icons.css"><link rel="stylesheet" href="/assets/plugins/slick/slick.css"><link href="/assets/scss/style.css" rel="stylesheet"><link rel="shortcut icon" href="/assets/images/favicon.png " type="image/x-icon"><link rel="icon" href="/assets/images/favicon.png " type="image/x-icon"> <script async src="https://www.googletagmanager.com/gtag/js?id=G-MM2F5FN4DZ"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MM2F5FN4DZ'); </script></head><header class="navigation fixed-top"><nav class="navbar navbar-expand-lg navbar-dark"> <a class="navbar-brand font-tertiary h3" href="#"><h3 class="text-white font-tertiary">Blogs</h3></a> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button><div class="collapse navbar-collapse text-center" id="navigation"><ul class="navbar-nav ml-auto"><li class="nav-item active"> <a class="nav-link" href="/">Back</a></li></ul></div></nav></header><section class="page-title bg-primary position-relative"><div class="container"><div class="row"><div class="col-12 text-center"><h1 class="text-white font-tertiary">Adding NavMesh, Agents and Animation in Cocos2d-x</h1></div></div></div><img src="/assets/images/illustrations/page-title.png" alt="illustrations" class="bg-shape-1 w-100"> <img src="/assets/images/illustrations/leaf-pink-round.png" alt="illustrations" class="bg-shape-2"> <img src="/assets/images/illustrations/leaf-orange.png" alt="illustrations" class="bg-shape-4"> <img src="/assets/images/illustrations/leaf-yellow.png" alt="illustrations" class="bg-shape-5"> <img src="/assets/images/illustrations/dots-group-cyan.png" alt="illustrations" class="bg-shape-6"> <img src="/assets/images/illustrations/leaf-cyan-lg.png" alt="illustrations" class="bg-shape-7"></section><section class="section"><div class="container"><div class="row"><section class="subsection"><h3>NavMesh</h3><p> What is a NavMesh? It is short for Navigation Mesh and is the underlying data structure for path queries. <a class="text-dark" href="https://en.wikipedia.org/wiki/Navigation_mesh" target="_blank">Wikipedia</a> defines it better,<pre class="text-dark">
A navigation mesh is a collection of two-dimensional convex polygons (a polygon mesh) that define which areas of an environment 
are traversable by agents. In other words, a character in a game could freely walk around within these areas unobstructed by trees,
lava, or other barriers that are part of the environment. Adjacent polygons are connected in a graph.

Path-finding within one of these polygons can be done trivially in a straight line because the polygon is convex and traversable.
Path-finding between polygons in the mesh can be done with one of the large numbers of graph search algorithms, such as A*. Agents
on a navmesh can thus avoid computationally expensive collision detection checks with obstacles that are part of the environment.
	</pre></p><p> Many game engines support this for AI path-finding and to accomplish point-and-click movements in a strategy game. It naturally supports the idea of obstacles and non-traversable or differently traversable areas. We can construct the NavMesh by parsing the terrain geometry guided by parameters. Agents navigate the NavMesh constrained by their own set of parameters like velocity, acceleration, etc.</p></section></div><div class="row"><section class="subsection"><h3>Cocos2d-x and recast</h3><p> Cocos2d-x supports NavMesh and Agents, but I couldn't find and easy-to-follow documentation for beginners. The source code has samples that show a use case of these objects. The NavMesh class encapsules the Detour objects and expects a baked NavMesh in binary format along with a geometry file. Cocos2d-x lists <a class="text-dark" href="https://github.com/recastnavigation/recastnavigation" target="_blank">recastnavigation</a> as an external dependency accompanied by Detour for path-finding. We can see the expected header definition for the binary input in the mesh construction methods. Now, I just had to mimic/find the serialization in recast.</p><noscript><pre>    // Read header.
    unsigned int offset = 0;
    TileCacheSetHeader header = *((TileCacheSetHeader*)(data.getBytes() + offset));
    offset += sizeof(TileCacheSetHeader);
    //static const int TILECACHESET_MAGIC = 
    //&#39;T&#39; &lt;&lt; 24 | &#39;S&#39; &lt;&lt; 16 | &#39;E&#39; &lt;&lt; 8 | &#39;T&#39;; //&#39;TSET&#39;;
    if (header.magic != TILECACHESET_MAGIC)
    {
        return false;
    }
    if (header.version != TILECACHESET_VERSION)
    {
        return false;
    }</pre></noscript><script src="https://gist.github.com/4aac4e1080e79b062beec1b2d0d5a607.js"> </script><p>Luckily, Recast has a demo sample built on SDL, which offers a friendly GUI for Mesh construction and visualization. The Rasterization parameter influences the size of generated tiles as it influences the generation of voxels used to build the NavMesh. Agent Radius controls the boundary of the mesh, and Max Slope limits steep geometry. Users can also control the number of output tiles. 'Temp Obstacles' generates multiple tiled meshes and writes out the cocos-compatible all_tiles_tilecache.bin file on saving. Pressing the '9' key writes out the geometry file as %meshname%.gset. The file contains Off-Mesh links, which connect two disjoint NavMesh polygons or shortens an otherwise longer path. We use Off-Mesh links for a variety of effects, such as jumping and swimming. Configuring agents with a specific type can filter some entities while allowing others via the link. For example, only after learning the swimming skill, the player can cross the river and explore other islands.</p><img src="/assets/images/blog/navmesh_animation/tile_mesh.png" alt="TileMesh" class="img-fluid rounded d-block" style="margin-bottom:3rem;margin-top:3rem"><p> The current workflow only supports non-dynamic meshes. We can make it dynamic with recast objects for a much larger open-world project like Gothic or Skyrim. Another strategy could be to use a TileManger object with a limited number of tiles around the player node, and as we move, we swap in new tiles for old ones and activate-deactivate AI agents. I will use this to build a basic RPG, a portfolio item focusing more on character design and mechanics. NavMesh optimization is not the focus area(at least for now).</p><noscript><pre>    auto navMesh = NavMesh::create(&quot;plane.bin&quot;, &quot;plane.gset&quot;);
    navMesh-&gt;setDebugDrawEnable(true);
    this-&gt;setNavMesh(navMesh);
    this-&gt;setNavMeshDebugCamera(_camera);

    NavMeshAgentParam param;
    param.radius = 0.5;
    param.height = 8;
    param.maxSpeed = 5;
    param.maxAcceleration = 100;
    _agent = NavMeshAgent::create(param);

    auto node = Node::create();
    node-&gt;addComponent(_agent);
    this-&gt;addChild(node);</pre></noscript><script src="https://gist.github.com/6681733d1eeb1a7d780ee4fec945d844.js"> </script><p> The mesh can then be inserted into the game using a few lines of code. Scene object stores an internal pointer for the NavMesh, and the game loop is rigged to support locomotion. NavMeshAgent class wraps a dtCrowdAgent as a Component that can be added to a Node. It is parameterized to move with a certain velocity and acceleration and have an avoidance radius. If the acceleration value is low in some proportion to the velocity parameter with the custom implementation, the agent exhibits damped oscillations.</p><noscript><pre>    mouseListener-&gt;onMouseDown = [=](EventMouse *event) {
        auto loc = event-&gt;getLocationInView();
	auto size = Director::getInstance()-&gt;getWinSize();
	// mouse events generate bottom left origin and unproject
	// expects top left, do this to compensate
	loc.y = size.height - loc.y;

        auto far = Vec3{loc.x, loc.y, 1.0};
        _camera-&gt;unproject(size, &amp;far, &amp;far);
	
        Physics3DWorld::HitResult result;
        this-&gt;getPhysics3DWorld()-&gt;rayCast(_camera-&gt;getPosition3D(), far, &amp;result);

        auto hitPos = result.hitPosition;

	_agent-&gt;move(hitPos);
    };</pre></noscript><script src="https://gist.github.com/2dff91d78d80ac6cad793d0fb3efc27f.js"> </script><p> The RPG is mobile-based with the basic idea of a company of characters around a player unit. Characters are typical RPG with different stats and leveling up schemes. The player's level determines the size of its company. Touch inputs move the company around in search of enemy companies to conquer and level up.</p><p>To support the primary player interaction, one has to figure out the 3D coordinates of the screen-space point. Unprojecting the homogenized coordinate and casting a ray from the camera's position to the unprojected point gives us the required coordinate on terrain geometry. I used the physics engine for raycasting, and the hit-result is used to navigate a solo agent.</p></section></div><div class="row"><section class="subsection"><h3>Animations</h3><p>In progress, getting fbx-conv to work.</p></section></div></div></section><footer class="bg-dark"><div class="section"><div class="container"><div class="row"><div class="col-md-4"><h5 class="text-light">Email</h5><p class="text-white paragraph-lg font-secondary">SiddharthJSingh@protonmail.com</p></div><div class="col-md-4"><h5 class="text-light">Phone</h5><p class="text-white paragraph-lg font-secondary">+91 9000968078</p></div><div class="col-md-4"><h5 class="text-light">Address</h5><p class="text-white paragraph-lg font-secondary">C/O Jagpal Singh, Near E.S.I Office, 4th Cross Road, Junglighat, Port Blair-744103, India</p></div></div></div></div><div class="border-top text-center border-dark py-5"><p class="mb-0 text-light"><p>Copyright © 2020 Designed by <a href="https://themefisher.com">Themefisher</a> &amp; Developed by <a href="https://getjekyllthemes.com">Getjekyllthemes</a></p></p></div></footer><script src="/assets/plugins/jQuery/jquery.min.js"></script> <script src="/assets/plugins/bootstrap/bootstrap.min.js"></script> <script src="/assets/plugins/shuffle/shuffle.min.js"></script> <script src="/assets/plugins/slick/slick.min.js"></script> <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> <script src="/assets/js/script.js"></script></body></html>
